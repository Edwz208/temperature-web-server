<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>TempCheck</title>
  <link rel="stylesheet" href="style.css" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
  <link href='https://fonts.googleapis.com/css?family=Radio Canada Big' rel='stylesheet'>
</head>
<body>
  <div class="container" id="container">
    <h1>Temperature Readings</h1>
    <div class="reading">
      <div class="temperature">
        <strong>Current Temperature:</strong>
        <span id="temperaturereading">0°C</span>
      </div>
      <div class="humidity">
        <span><strong>Humidity:</strong></span>
        <span id="humidityreading">0%</span>
      </div>
      <div class="time">
        <strong>Time:</strong>
        <span id="time">00:00:00</span>
      </div>
    </div>
  </div>
  <h1 class="graphtitle">Temperature vs Time Graph</h1>
  <div class="avgTmp">Average Temperature:  </div>
  <div class="hide">Average of 15 temperature Readings.</div>

  <input class="inputBox" type="text" id="thresBox"  placeholder="(Enter A Temperature Threshold)"/>
  
  
  <div class="avgHmd">Average Humidity:  </div>
  <div class="hide2">Average of 15 humidity Readings.</div>
  <canvas class="graphcontainer" id="temperatureChart"></canvas>
  <div class = "b" >
    <button  class = tempB onclick="toggleGraph('temperature')">Temperature</button>
    <button class = humidB onclick="toggleGraph('humidity')">Humidity</button>
  </div>
  <script>
    document.addEventListener('DOMContentLoaded', (event) => {
  var ctx = document.getElementById('temperatureChart').getContext('2d');
  var temperatureChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: [],
      datasets: [{
        label: 'Temperature (°C)',
        data: [],
        fill: false,
        borderColor: 'rgb(255, 0, 0)',
        tension: 0.1
      }]
    },
    options: {
      scales: {
        x: {
          type: 'time',
          time: {
            unit: 'second'
          }
        },
        y: {
          beginAtZero: true
        }
      }
    }
  });

  const maxDataPoints = 4; // 3 hours of data points at 1 point every 6 seconds
  let dataBuffer = [];

  function fetchData() {
    fetch('/data')
      .then(response => response.json())
      .then(data => {
        console.log("Data fetched:", data); // Debug output
        document.getElementById('temperaturereading').textContent = data.temperature + '°C';
        document.getElementById('humidityreading').textContent = data.humidity + '%';
        document.getElementById('time').textContent = data.time;

        // Convert time data to JavaScript Date object
        const timeParts = data.time.split(':');
        const time = new Date();
        time.setHours(parseInt(timeParts[0]));
        time.setMinutes(parseInt(timeParts[1]));
        time.setSeconds(parseInt(timeParts[2]));

        dataBuffer.push({ time: time, temperature: data.temperature });

        if (dataBuffer.length > maxDataPoints) {
          dataBuffer.shift(); // Remove the oldest data point
        }

        temperatureChart.data.labels = dataBuffer.map(d => d.time);
        temperatureChart.data.datasets[0].data = dataBuffer.map(d => d.temperature);

        temperatureChart.update();
      })
      .catch(error => console.error('Error fetching data:', error));
  }

  setInterval(fetchData,2000); // Match the interval to your Arduino update frequency
});

  </script>
</body>
</html>
